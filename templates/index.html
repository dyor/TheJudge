<!DOCTYPE html>
<html>
<head>
    <title>CTEF Flight Control</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #222; color: #fff; }
        .box { border: 1px solid #444; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #333; }
        .prompt { background: #222; padding: 15px; font-family: monospace; white-space: pre-wrap; height: 150px; overflow-y: scroll; border: 1px solid #555; }
        .buttons { display: none; gap: 20px; margin-top: 20px; }
        button { padding: 10px 20px; font-size: 16px; border: none; cursor: pointer; color: white; border-radius: 5px; }
        input { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #555; background: #444; color: white; }

        .nit { background-color: #f39c12; }
        .issue { background-color: #c0392b; }
        .primary { background-color: #3498db; }
        .view-btn { background-color: #9b59b6; padding: 5px 10px; font-size: 12px; }

        /* Progress Bar Styles */
        .progress-container { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .progress-btn { flex: 1; background-color: #444; color: #aaa; padding: 8px; font-size: 14px; border-radius: 4px; transition: background 0.2s; }
        .progress-btn:hover { background-color: #555; }
        .progress-btn.active { background-color: #27ae60; color: white; font-weight: bold; border: 1px solid #2ecc71; }

        /* Stats Styles */
        .stats-container { display: flex; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #555; }
        .stat-item { flex: 1; background: #2a2a2a; padding: 10px; border-radius: 5px; text-align: center; }
        .stat-title { font-size: 12px; color: #aaa; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 20px; font-weight: bold; color: #fff; }
        .stat-sub { font-size: 12px; color: #888; margin-top: 5px; }

        .status { font-weight: bold; color: #2ecc71; }
        .blocked { color: #e74c3c; animation: blink 1s infinite; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: left; }
        th { background-color: #444; }
        tr:nth-child(even) { background-color: #2a2a2a; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #333; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; color: #ddd; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: #fff; text-decoration: none; cursor: pointer; }
        pre { background: #222; padding: 10px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <h1>üõ´ CTEF Flight Control</h1>

    <!-- PROJECT SELECTION -->
    <div class="box">
        <h3>Current Project: <span id="currentProjectName" style="color: #3498db;">{{ project_name }}</span></h3>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
            <input type="text" id="newProjectInput" placeholder="Enter new project name" value="{{ project_name }}">
            <button class="primary" onclick="setProject()">Set Project</button>
        </div>

        <!-- PROGRESS TRACKING -->
        <h4>Progress Completion: <span id="progressDisplay">{{ current_progress }}%</span></h4>
        <div class="progress-container">
            {% for p in range(0, 101, 10) %}
            <button class="progress-btn {% if p == current_progress %}active{% endif %}" onclick="setProgress({{ p }})">{{ p }}%</button>
            {% endfor %}
        </div>

        <!-- RUNNING TALLY -->
        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-title">‚è±Ô∏è Time Elapsed</div>
                <div class="stat-value">{{ stats.duration }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-title">üî¢ Tokens</div>
                <div class="stat-value">{{ stats.tokens.total }}</div>
                <div class="stat-sub">In: {{ stats.tokens.in }} | Out: {{ stats.tokens.out }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-title">üö® Interventions</div>
                <div class="stat-value">{{ stats.interventions.total }}</div>
                <div class="stat-sub">Nit: {{ stats.interventions.nit }} | Issue: {{ stats.interventions.issue }}</div>
            </div>
        </div>
    </div>

    <!-- INTERVENTION PANEL -->
    <div class="box">
        <h3>Current Status: <span id="statusText" class="status">RUNNING</span></h3>
        <div class="prompt" id="promptDisplay">System is running... no intervention needed.</div>

        <div class="buttons" id="actionButtons">
            <button class="nit" onclick="classify('NIT')">üõ†Ô∏è NIT (Minor Fix)</button>
            <button class="issue" onclick="classify('ISSUE')">üö® ISSUE (Strategic Redirect)</button>
        </div>
    </div>

    <!-- RECENT ACTIVITY LOGS -->
    <div style="display: flex; gap: 20px;">

        <!-- Traffic Logs -->
        <div class="box" style="flex: 1;">
            <h3>Recent Traffic Logs</h3>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Project</th>
                        <th>%</th>
                        <th>In</th>
                        <th>Out</th>
                        <th>Latency</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.timestamp }}</td>
                        <td>{{ log.project_name }}</td>
                        <td>{{ log.progress_percentage if log.progress_percentage is not none else '-' }}%</td>
                        <td>{{ log.tokens_in }}</td>
                        <td>{{ log.tokens_out }}</td>
                        <td>{{ log.latency_ms }}ms</td>
                        <td>
                            <button class="view-btn" onclick='showModal({{ log.full_response | tojson }})'>View</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Interventions -->
        <div class="box" style="flex: 1;">
            <h3>Recent Interventions</h3>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Project</th>
                        <th>Classification</th>
                        <th>Prompt Snippet</th>
                    </tr>
                </thead>
                <tbody>
                    {% for int in interventions %}
                    <tr>
                        <td>{{ int.timestamp }}</td>
                        <td>{{ int.project_name }}</td>
                        <td>
                            <span style="color: {{ 'orange' if int.classification == 'NIT' else 'red' }}">
                                {{ int.classification }}
                            </span>
                        </td>
                        <td>{{ int.prompt_text[:50] }}...</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

    <!-- MODAL -->
    <div id="responseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Full Response JSON</h3>
            <pre id="modalJsonContent"></pre>
        </div>
    </div>

    <!-- MERMAID DIAGRAM -->
    <div class="box">
        <h3>Architecture Sequence Diagram</h3>
        <pre class="mermaid">
sequenceDiagram
    participant Dev as Android Studio (Emulator)
    participant Proxy as CTEF Proxy (mitmproxy)
    participant Dash as Dashboard (FastAPI)
    participant Human as Human Evaluator
    participant DB as SQLite DB
    participant LLM as Gemini API

    Note over Dev, Proxy: Traffic Interception
    Dev->>Proxy: HTTP Request (Prompt)

    Note over Proxy, Dash: "Human-in-the-Loop" Pause
    Proxy->>Dash: Block Request & Send Metadata
    Dash->>Human: Display Request for Review
    Human->>Dash: Classify (Nit/Intervention/Pass)
    Dash->>DB: Log Classification
    Dash->>Proxy: Resume Signal

    Note over Proxy, LLM: Execution
    Proxy->>LLM: Forward Request
    LLM-->>Proxy: Response (Code/Answer)

    Note over Proxy, DB: Metric Capture
    Proxy->>Dash: Report Latency & Token Usage
    Dash->>DB: Log Final Metrics
    Proxy-->>Dev: Return Response
        </pre>
    </div>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true, theme: 'dark' });
</script>

<script>
    function setProject() {
        const name = document.getElementById('newProjectInput').value;
        fetch('/set_project', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({project_name: name})
        })
        .then(r => r.json())
        .then(data => {
            window.location.reload();
        });
    }

    function setProgress(val) {
        fetch('/set_progress', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({progress: val})
        })
        .then(r => r.json())
        .then(data => {
            // Update UI buttons
            document.querySelectorAll('.progress-btn').forEach(btn => btn.classList.remove('active'));
            // Find the button with the matching text and make it active
            // (Using textContent is simple since we generated them)
            const btns = document.querySelectorAll('.progress-btn');
            for(let btn of btns) {
                if(btn.textContent.trim() === val + '%') {
                    btn.classList.add('active');
                    break;
                }
            }
            document.getElementById('progressDisplay').textContent = val + "%";
        });
    }

    function classify(type) {
        // Optimistic UI update
        document.getElementById('actionButtons').style.display = 'none';
        document.getElementById('statusText').innerText = 'RUNNING';
        document.getElementById('statusText').className = 'status';
        document.getElementById('promptDisplay').innerText = 'Resuming...';

        fetch('/classify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({type: type})
        }).then(() => {
            // Reload to show the new intervention in the table
            setTimeout(() => window.location.reload(), 500);
        });
    }

    // Modal Functions
    function showModal(jsonData) {
        if (!jsonData) {
            document.getElementById('modalJsonContent').textContent = "No JSON data captured.";
        } else {
            try {
                // If it's a string, try to parse it to format it nicely
                const obj = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
                document.getElementById('modalJsonContent').textContent = JSON.stringify(obj, null, 2);
            } catch (e) {
                document.getElementById('modalJsonContent').textContent = jsonData;
            }
        }
        document.getElementById('responseModal').style.display = "block";
    }

    function closeModal() {
        document.getElementById('responseModal').style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('responseModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Poll for blocked state every 500ms
    let isBlocked = false;

    setInterval(() => {
        fetch('/status').then(r => r.json()).then(data => {
            if (data.status === 'BLOCKED') {
                isBlocked = true;
                document.getElementById('statusText').innerText = 'üõë BLOCKED - INTERVENTION NEEDED';
                document.getElementById('statusText').className = 'status blocked';
                document.getElementById('promptDisplay').innerText = data.text;
                document.getElementById('actionButtons').style.display = 'flex';
            } else {
                if(isBlocked) {
                    isBlocked = false;
                    document.getElementById('statusText').innerText = 'RUNNING';
                    document.getElementById('statusText').className = 'status';
                    document.getElementById('actionButtons').style.display = 'none';
                }
            }
        });
    }, 1000);
</script>
</body>
</html>